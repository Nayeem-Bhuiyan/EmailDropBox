@model MailRequest
@{
    ViewData["Title"] = "emailDataSend";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section Style{
    <style>

        #loadingImg{
            display:none;
        }
    </style>
}
<div class="row">
    <div class="col-md-12">
        <h5>Email Send to Client</h5>
        <div class="row" id="LoadingDiv">
            <div class="ajax-loader">
                <img src="~/assets/images/avatars/loading.gif" id="loadingImg" class="img-responsive" />
                <div id="preview"></div>
            </div>
        </div>
        <form id="frmData" method="post" enctype="multipart/form-data">
            <div class="row" id="emailInfoDiv">
                <div class="col-md-12">
                    Email <input type="text" name="ToEmail" id="ToEmail" class="form-control" value="" required /><br />
                    Subject<input type="text" name="Subject" id="Subject" class="form-control" value="" /><br />
                    Body<input type="text" name="Body" id="Body" class="form-control" value="" /><br />
                    Upload<input type="file" name="Attachments" class="form-control" id="Attachments" value="" multiple required/>
                    <button type="submit" id="btnSave" class="btn btn-primary">Save</button>
                </div>
            </div>

            <br />

        </form>
        <br />
        <div class="col-md-12">

        </div>
    </div>
</div>

@section Scripts{

    <script>


        $(document).ready(function () {

            jQuery('input[type="file"]').each(function () {
                $this = jQuery(this);
                $this.on('change', function () {
                    var fsize = $this[0].files[0].size,
                        ftype = $this[0].files[0].type,
                        fname = $this[0].files[0].name,
                        fextension = fname.substring(fname.lastIndexOf('.') + 1);
                    validExtensions = ["jpg", "pdf", "jpeg", "gif", "png", "doc", "docx", "xls", "xlsx", "ppt", "pptx", "txt", "zip", "rar", "gzip"];

                    if ($.inArray(fextension, validExtensions) == -1) {
                        alert("This type of files are not allowed!");
                        this.value = "";
                        return false;
                    } else {
                        if (fsize > 2097152) {/*1048576-1MB(You can change the size as you want)*/
                            alert("File size too large! Please upload less than 2MB");
                            this.value = "";
                            return false;
                        } else {
                            loadFile();

                            return true;

                        }

                    }

                });
            });




        });

        function previewImages() {

            var preview = document.querySelector('#preview');

            if (this.files) {
                [].forEach.call(this.files, readAndPreview);
            }

            function readAndPreview(file) {

                // Make sure `file.name` matches our extensions criteria
                if (!/\.(jpe?g|png|gif)$/i.test(file.name)) {
                    return alert(file.name + " is not an image");
                } // else...

                var reader = new FileReader();

                reader.addEventListener("load", function () {
                    var image = new Image();
                    image.height = 100;
                    image.title = file.name;
                    image.src = this.result;
                    preview.appendChild(image);
                });

                reader.readAsDataURL(file);

            }

        }
        document.querySelector('#Attachments').addEventListener("change", previewImages);


        $('#btnSave').click(function () {

            $('#frmData').on('submit', function (event) {

                event.preventDefault();
                
                    
                
                var form = $("#frmData")[0];
                var frmdata = new FormData(form);
                for (var i = 0; i < frmdata.length; i++) {
                    frmdata.append("Attachments", files[i]);
                }
                frmdata.append("ToEmail", $('#ToEmail').val());
                frmdata.append("Subject", $('#Subject').val());
                frmdata.append("Body", $('#Body').val());
                console.log(frmdata);
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You want to save this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, save it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: "/EmailInfo/Email/emailDataSend",
                            type: "POST",
                            data: frmdata,
                            enctype: "multipart/form-data",
                            dataType: "json",
                            processData: false,
                            contentType: false,
                            cache: false,
                            timeout: 600000,
                            beforeSend: function () {
                                $('#btnSave').attr('disabled', 'disabled');
                                $('#btnSave').val('Submitting...');
                                $('loadingImg').show();
                              
                            }
                        }).done(function (data) {
                            $('loadingImg').hide();
                            swal.fire('success', 'Saved Successfully!', 'success').then(function() {
                                location.reload();
                            });
                        }).fail(function () {
                            $('loadingImg').hide();

                            swal.fire('warning', 'Failed!', 'warning');
                        })
                    }

                });

            })




        })
    </script>
}